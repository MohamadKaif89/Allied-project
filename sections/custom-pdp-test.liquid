<section>
    <div class="pdp-container">
        {% unless product.tags contains "free-gift-hidden" %}
            
        
        <div class="pdp-row">
            <div class="leftimg">
                <img src="{{product.featured_image |  image_url }}" alt="" width="" height="">
            </div>
            {% comment %} Right Content {% endcomment %}
            <div class="right-items">
                <h1>{{product.title}}</h1>
                {% assign v = product.selected_or_first_available_variant %}
                <div class="price-wrapper">
                    <span class="price">
                        {{v.price | money}}
                    </span>
                    {% if v.compare_at_price > v.price %}
                    <span class="compare-price">
                        <del>{{v.compare_at_price | money}}</del>
                    </span>
                    {% endif %}
                </div>
                <div class="product-description">
                    <p>{{product.description}}</p>
                </div>
                {% comment %} MainQuantity {% endcomment %}
                <div class="qty">
                    <label for="qty">Qty:</label>
                    <input type="number" id="" value="1" min="1"
                        max="{{product.selected_or_first_available_variant.inventory_quantity}}"
                        data-stock="{{product.selected_or_first_available_variant.inventory_quantity}}">
                </div>
                {% comment %} Add to cart button {% endcomment %}
                 {% unless product.tags contains "free-gift-hidden" %}
                    
                
                <form action="">
                    <button class="addToCartBtn" type="submit"
                        data-main-variant="{{product.selected_or_first_available_variant.id}}">Add To Cart</button>

                </form>
                 {% endunless %}

                {% comment %} Add on Products {% endcomment %}
                {% if product.metafields.custom.add_on_products.value != blank %}

                <div class="addons">
                    <h3>Add on Products</h3>
                    {% for addonProduct in product.metafields.custom.add_on_products.value %}
                    <div class="addon-wrapper">
                        <img src="{{addonProduct.featured_image |  image_url }}" alt="{{addonProduct.title}}" width=""
                            height="">
                        <div class="addon-info">
                            <label for="">
                                {{addonProduct.title}}
                            </label>
                            <input type="checkbox" class="addonCheck"
                                data-variant="{{addonProduct.selected_or_first_available_variant.id}}">
                            {% if addonProduct.variants.size > 1 %}
                            <select class="addonVariant">
                                {% for variant in addonProduct.variants %}

                                <option value="{{variant.id}}">
                                    {{variant.title}} - {{variant.price | money}}
                                </option>

                                {% endfor %}
                            </select>
                            {% else %}
                            <input type="hidden" class="addonVariant"
                                value="{{addonProduct.selected_or_first_available_variant.id}}">
                            {% endif %}
                            <div class="addon-price">
                                <h3>{{addonProduct.selected_or_first_available_variant.price | money}}</h3>
                            </div>
                            <input type="number" class="addonQty" value="1" min="1"
                                max="{{addonProduct.selected_or_first_available_variant.inventory_quantity}}"
                                data-stock="{{addonProduct.selected_or_first_available_variant.inventory_quantity}}">

                        </div>

                    </div>
                    {% endfor %}

                </div>
                {% endif %}
            </div>
        </div>
        {% endunless %}
    </div>
</section>
{% schema %}
{
"name": "Pdp Test",
"settings": [],
"presets": [
{
"name": "Pdp Test"
}
]
}
{% endschema %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    .pdp-container {
        width: 100%;
        max-width: calc(1440px - 90px - 90px);
        margin: auto;
    }

    .pdp-row {
        display: flex;
        gap: 38px;

    }

    .leftimg {
        max-width: 56.75%;
        padding: 0 50px;
    }

    .leftimg img {
        width: 100%;
    }

    .right-items {
        width: 100%;
        max-width: 30.6%;
    }

    .addToCartBtn {
        padding: 12px 24px;
        margin-top: 16px;
        background-color: black;
        cursor: pointer;
        color: white;
    }

    .addons {
        margin-top: 30px;
        width: 100%;
        max-width: clamp(285px, 100%, 285px);
    }

    .addon-wrapper {
        display: flex;
        gap: 12px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        margin-bottom: 16px;
        background: #fff;

    }

    .qty input {
        width: 100%;
        max-width: 23%;
        padding: 6px;
    }

    .addon-wrapper img {
        width: 100%;
        max-width: 120px;
        display: block;
        margin-bottom: 10px;
        border-radius: 6px;
    }


    .addon-info label {
        font-weight: 600;
        font-size: 14px;
        display: block;
        margin-bottom: 6px;
    }

    .addon-info input[type="checkbox"] {
        margin-bottom: 8px;
    }

    .addon-info select {

        width: 100%;
        padding: 6px;
        margin-bottom: 8px;
    }

    .addon-price h3 {
        font-size: 14px;
        margin-bottom: 8px;
    }

    .addonQty {
        width: 100%;
        padding: 6px;
    }

    @media (max-width: 768px) {
        .pdp-row {
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }

        .leftimg {
            max-width: 100%;
            padding: 0;
            text-align: center;
        }

        .leftimg img {
            max-width: 90%;
            margin: 0 auto;
        }

        .right-items {
            max-width: 100%;
            text-align: center;
        }

        .qty {
            justify-content: center;
        }

        .addToCartBtn {
            width: 100%;
            max-width: 320px;
            margin: 16px auto 0;
            display: block;
        }

        .addons {
            max-width: 100%;
            margin: 30px auto 0;
            text-align: center;
        }

        .addon-wrapper {
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-top: 151px;
            max-width: 50%;
            margin: 10px auto;
            border: 1px solid black;
        }

        .addon-wrapper img {
            max-width: 120px;
            margin: 0 auto 10px;
        }

        .addon-info {
            width: 100%;
            align-items: center;
        }

        .addon-info select,
        .addonQty {
            max-width: 200px;
            margin: 0 auto 8px;
        }

    }
</style>

<script>
    const body = document.querySelector('body');
    const addToCartBtn = document.querySelector('.addToCartBtn');

    // Add to Cart
    addToCartBtn.addEventListener('click', async function (e) {
        e.preventDefault();

        const text = addToCartBtn.innerText;
        addToCartBtn.innerText = 'Adding...';
        addToCartBtn.disabled = true;

        let items = [];

        // Main Product validation
        const mainVariantId = addToCartBtn.dataset.mainVariant;
        const mainQtyInput = document.querySelector('.qty input');
        const mainQty = Number(mainQtyInput.value);
        const mainStock = Number(mainQtyInput.dataset.stock);

        if (mainQty > mainStock) {
            alert(`Only ${mainStock} items left for this product`);
            resetButton();
            return;
        }

        items.push({
            id: mainVariantId,
            quantity: mainQty
        });

        // Add on Product
        const addonWrappers = document.querySelectorAll('.addon-wrapper');

        for (const addon of addonWrappers) {
            const checkbox = addon.querySelector('.addonCheck');
            if (!checkbox.checked)
                continue;

            const addonVariantId = addon.querySelector('.addonVariant').value;
            const qtyInput = addon.querySelector('.addonQty');
            const addonQty = Number(qtyInput.value);
            const addonStock = Number(qtyInput.dataset.stock);

            if (addonQty > addonStock) {
                alert(`Low quantity available. Only ${addonStock} items left Addons Products`);
                resetButton();
                return;
            }
            items.push({
                id: addonVariantId,
                quantity: addonQty
            });
        }
        // Cart Api
        try {
            const response = await fetch('/cart/add.js', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items })
            });

            if (!response.ok)
                throw new Error('Cart add failed');
            const data = await response.json();
            console.log("Added Data", data);
            await updateCartBubble();
            addToCartBtn.innerText = 'Added';
            setTimeout(resetButton, 3000);

        } catch (error) {
            console.error(error);
            alert('Something went wrong while adding to cart');
            resetButton();
        }
        //  Function to reset Button
        function resetButton() {
            addToCartBtn.innerText = text;
            addToCartBtn.disabled = false;
        }
    });

    // Cart Bubble Function
    const updateCartBubble = async () => {
        const res = await fetch(window.Shopify.routes.root + 'cart.js');
        const cart = await res.json();
        let bubble = document.querySelector('.cart-count-bubble');
        if (!bubble && cart.item_count > 0) {
            bubble = document.createElement('div');
            bubble.className = 'cart-count-bubble';
            document.querySelector('.header__icon--cart').append(bubble);
            body.classList.remove('empty-cart');
        }
        if (bubble) {
            bubble.innerText = cart.item_count;
            bubble.classList.toggle('hidden', cart.item_count === 0);
        }
    };

</script>