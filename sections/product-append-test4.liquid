<div class="pdp-wrapper">

    <div class="pdp-left">

        <div class="swiper main-swiper">
            <div class="swiper-wrapper">
                {% for media in product.media %}
                <div class="swiper-slide">
                    <img src="{{ media | image_url}}" width="" height="">
                </div>
                {% endfor %}
            </div>

            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>
        <div class="swiper thumb-swiper">
            <div class="swiper-wrapper">
                {% for media in product.media %}
                <div class="swiper-slide">
                    <img src="{{ media | image_url }}" width="" height="">
                </div>
                {% endfor %}
            </div>
        </div>

    </div>

    <div class="pdp-right">

        <h1 id="pdp-title">{{ product.title }}</h1>

        <p id="pdp-price">{{ product.price | money }}</p>

        <label>Select Variant</label>
        <select id="variant-select">
            {% for v in product.variants %}
            <option value="{{ v.id }}">{{ v.title }}</option>
            {% endfor %}
        </select>

        <button id="addToCartBtn">Add To Cart</button>


        <h3>Other Colors</h3>

        <div class="related-wrapper">
            {% for p in product.metafields.custom.product_append.value %}
            <button class="related-btn" data-handle="{{ p.handle }}">
                <img src="{{ p.featured_image | image_url }}" width="" height="">
                <span>{{ p.title }}</span>
            </button>
            {% endfor %}
        </div>

    </div>

</div>

<div id="append-new"></div>

{% schema %}
    {
        "name": "Producct Append another",
        "settings": [],
        "presets": [
            {
                "name": "Prodcut Append another"
            }
        ]
    }
{% endschema %}
<style>
        .pdp-wrapper {
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
        align-items: flex-start;
    }
    .pdp-left,
    .pdp-right {
        flex: 1;
        min-width: 300px;
    }

    .main-swiper {
        width: 100%;
        border-radius: 12px;
        overflow: hidden;
    }

    .main-swiper .swiper-slide {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: white;
        border-radius: 12px;
    }

    .main-swiper img {
        width: 100%;
        height: 420px;
        object-fit: cover;
        border-radius: 12px;
    }


    .thumb-swiper {
        margin-top: 10px;
    }

    .thumb-swiper .swiper-slide {
        height: 80px;
        width: 80px;
        border: 2px solid transparent;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
    }

    /* .thumb-swiper .swiper-slide-thumb-active {
        border-color: black;
    } */

    .thumb-swiper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 10px;
    }

    .swiper-button-next,
    .swiper-button-prev {
        color: #000;
        background-color: white;
        border-radius: 50%;
        width: 36px;
        height: 36px;
    }

    .swiper-button-next:after,
    .swiper-button-prev:after {
        font-size: 16px;
    }
     #pdpTitle {
        margin: 0 0 5px 0;
    }

    #pdpPrice {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    #variantSelect {
        padding: 8px;
        width: 100%;
        max-width: 260px;
    }

    #addToCartBtn {
        margin-top: 10px;
        padding: 10px 16px;
       background-color: black;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }

    .related-wrapper {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 18px;
    }

    .related-btn {
        border: 1px solid #ddd;
     background-color: white;
        border-radius: 10px;
        padding: 6px;
        cursor: pointer;
        width: 90px;
        text-align: center;
    }

    .related-btn img {
        width: 100%;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
    }

    .related-btn span {
        font-size: 12px;
        display: block;
        margin-top: 3px;
    }
    .append-box{
     width: 100%;
    margin-top: 20px;
    padding: 15px;
    border: 1px solid black;
    border-radius: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    }
    .preview-left{
   flex-basis: 58%;
    min-width: 300px;
    }
    .preview-right{
   flex-basis: 35%;
    min-width: 260px;
    }
    .pv-main img{
      width: 100%;
     height: 420px;
    object-fit: contain;
    }
    .pv-thumb{
     margin-top: 10px;
    }
    .pv-thumb .swiper-slide{
        width: 80px;
        height: 80px;
        overflow: hidden;
        cursor: pointer;
    }
    .pv-thumb img{
     width: 100%;
    height: 100%;
    object-fit: cover;
    }
    .pv-add{
     margin-top: 10px;
    padding: 10px 16px;
    background-color: black;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin-left: 20px;
    }

    @media(max-width:768px) {

        .main-swiper img {
            height: 300px;
        }

        .thumb-swiper .swiper-slide {
            width: 65px;
            height: 65px;
        }

        .pdp-wrapper {
            gap: 20px;
        }
        .preview-left,
        .preview-right{
            flex-basis: 100%;
        }
        .pv-main img{
         height: 300px;
        }
    }

</style>
<script>
    document.addEventListener("DOMContentLoaded", () =>{
        // thumbnail swiper
        const thumbs = new Swiper(".thumb-swiper", {
            slidesPerView: 4,
            spaceBetween: 10,
            watchSlidesProgress: true
        });
        // Main swiper
       const main = new Swiper(".main-swiper", {
        spaceBetween: 10,
        thumbs:{swiper: thumbs},
        navigation:{
            nextEl: ".swiper-button-next",
            prevEl: ".swiper-button-prev"
        }

        });

     const variantSelect =  document.getElementById("variant-select");
    const addBtn = document.getElementById("addToCartBtn");
    const appendNew = document.getElementById("append-new");

    async function addToCart(variantId){
        await fetch("/cart/add.js",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({
                id: variantId,
                quantity: 1
            })
        });
        alert("Added to cart")
    }
    
    // Main pdp add to cart
    addBtn.onclick = async () =>{
        await addToCart(variantSelect.value);
    }
    function money(amount){
        return "$"+(amount/100);
    }
    // loading product and append preview
    async function loadProduct(handle){
       
        const res = await fetch(`/products/${handle}.js`);
        const p = await res.json();
        const box = document.createElement("div");
        box.className = "append-box";
        box.innerHTML = `
        <div class="preview-left">
        <div class="swiper pv-main">
        <div class="swiper-wrapper">
        ${p.images.map(img =>`
        <div class="swiper-slide">
        <img src="${img}">
        </div>
        `).join("")}
        </div>

         <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        </div> 

        <div class="swiper pv-thumb">
        <div class="swiper-wrapper">
        ${p.images.map(img =>`
        <div class="swiper-slide">
        <img src="${img}">
        </div>
        `).join("")}
        </div>
        </div>

        </div>
        
        <div class="preview-right">
        <h2>${p.title}</h2>
        <p>${money(p.price)}</p>
        <p>${p.available ? "In Stock": "Out of Stock"}</p>
        <label>Select Variant</label>
        <select class="pv-variant">
        ${p.variants.map(v =>`
        <option value="${v.id}">${v.title}</option>
        
        `).join("")}
        </select>
        <button class="pv-add">
        Add To Cart
        </button>
        </div>

        `;
        appendNew.innerHTML="";
        appendNew.appendChild(box);

        const pvThumb = new Swiper(box.querySelector(".pv-thumb"),{
            slidesPerView: 4,
            spaceBetween: 10,
            watchSlidesProgress: true
        });
        const pvMain = new Swiper(box.querySelector(".pv-main"),{
            spaceBetween: 10,
            thumbs:{ swiper: pvThumb},
            navigation:{
                nextEl: box.querySelector(".swiper-button-next"),
                prevEl: box.querySelector(".swiper-button-prev")
            }
        });

        const pvSelect = box.querySelector(".pv-variant");
        pvSelect.onchange =() =>{
            const match = p.variants.find(v => v.id == pvSelect.value);
            if(match && match.featured_image){

                let variantImg = match.featured_image.src;
                variantImg = variantImg.replace("https:","").replace("http:","");
                const index = p.images.findIndex(img => img.includes(variantImg));
               
                if(index >= 0){
                    pvMain.slideTo(index);
                }
            }
            else{
                pvMain.slideTo(0);
            }
        }
        box.querySelector(".pv-add").onclick = async ()=>{
            await addToCart(pvSelect.value);

        };
    }
    document.querySelectorAll(".related-btn").forEach(btn => {
        btn.onclick= () => loadProduct(btn.dataset.handle);
    });

    })
</script>